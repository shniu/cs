# MQ

Message Queue 是目前微服务架构中应用非常广泛的中间件，主要用来做异步处理、服务解耦、流量削峰等。一个高性能、低延迟、高可用、高可靠的消息队列在互联网业务中是非常必要的。而在多数互联网公司中使用的 MQ 中间件产品有：

* Kafka
  * [nakadi](https://github.com/zalando/nakadi) - A distributed event bus that implements a RESTful API abstraction on top of Kafka-like queues
  * [allegro/hermes](https://github.com/allegro/hermes) - Fast and reliable message broker built on top of Kafka.
* RocketMQ
* RabbitMQ
* Pulsar
* pmq
* qmq
* NSQ
* Redis, 其实 Redis 并不能算一个 MQ 产品，它只是提供了一些 Queue 的能力，Pub/Sub 的能力

我们需要明白一个道理，**不存在一个完美的东西可以解决所有问题，往往是在引入一个新的东西时解决了我们的痛点，但是同样会引入其他复杂度，而这个引入的复杂度是否能被接受要看具体的场景进行权衡**；这个道理同样适用于 MQ，所以 MQ 不是银弹。

那么 MQ 主要解决了什么问题呢？MQ 很好的解决了耦合性问题、数据分发问题、流量激增问题，比如服务间的耦合，通常情况下服务间使用 RPC 的方式直接调用，这会带来服务间的耦合性比较大，引入 MQ 后可以利用发布-订阅模型，分离了调用方和被调用方，也就是实现了生产者和消费者；再比如我们需要将一份数据（或者一个事件）发送到多个服务中（因为我们使用了微服务架构，做了服务拆分），这个时候可以利用 MQ 解决数据分发问题；再比如在一个高并发的系统中，MQ 有缓冲数据的能力，所以对流量也有控制的能力，也就是削峰，不至于超大流量压垮系统。

此外由于 MQ 的这些能力，MQ 也被用来解决分布式事务问题，来实现数据的最终一致性：

1. 比如事务性消息的实现，RocketMQ 就实现了事务性消息，将数据的发送分为两个阶段，第一阶段是 Prepare 阶段的 Half Message，然后是在本地事务提交或回滚后触发 Commit 阶段的提交或回滚；此外还有一个补偿机制，当 Half Message 消息在一定时间后没有收到 Commit 消息，则会反查业务系统，这样就保证了数据发送的原子性，而这种保证是最终一致性的；消息发送成功后，消息是否被消费者正确消费，依赖于消费者自己的实现
2. 比如应用在分布式事务中，sagas 的实现可以基于 MQ 的通道来解耦合，减少服务间的直接调用，增加吞吐量和实现异步

还有在大数据的应用场景中，MQ 作为一个管道连接了数据和流计算任务，作为数据的中间存储。

当然，MQ 也会带来一些问题

1. MQ 增加了系统复杂度，比如 MQ 由多个 Broker 组成，肯定要解决 Broker 的可用性问题，服务发现问题、性能问题（延迟和吞吐量的权衡）；再比如发送给 MQ 的消息怎么做到不丢失，这个问题很关键；再比如 MQ 可以缓冲消息，如果消息积压了要能快速解决
2. 使用了 MQ 会把原本直接调用的方式转为异步的模式，这无形中增加了延迟，因为消息要经过 MQ 的 Broker 才能到达消费方，消费方成功消费后才能把结果反馈出来
3. 在整个的消息处理的过程中，可能会带来数据的不一致，比如订单创建成功了，但是可能还没有生成发货的订单，但这种不一致我们是可以接受的

### MQ 的几个关键问题

1. 项目中使用 MQ 解决什么问题？为什么要选择这个 MQ 产品？
2. 你了解的这个 MQ 产品的技术架构、部署架构是怎样的？它的设计做了哪些权衡？
3. MQ 怎么解决消息丢失问题？
4. MQ 怎么解决消息重复问题？
5. MQ 怎么解决消息积压问题？
6. 有没有使用过 MQ 的事务消息，怎么实现的？为什么使用？
7. MQ 的顺序消费如何实现？
8. 在生产环境中有什么好的实践来提升 MQ 的可靠性吗？在实际场景中是如何权衡消息可靠、低延迟等需要的？
9. 说一下你们公司的 MQ 的处理消息数，比如日处理消息多少，多少台机器，怎么部署的，有没有做过一些优化配置等等（实际使用运维压测经验）
10. MQ 实现的一些技术细节
    1. 消息传输协议、序列化与反序列化、内存管理、高性能网络 IO、异步设计、数据压缩
    2. 消息存储：Zero Copy、顺序写、WAL
    3. 消息索引：索引结构、高性能索引
    4. 并发控制：高性能锁设计、CAS、减少数据共享
    5. 分布式：Broker 的高可用设计、服务发现和注册、服务协调、生产和消费负载均衡、broker 间消息同步（数据一致性）



### MQ 相关文章汇总

[MQ 消息中间件分析](https://mp.weixin.qq.com/s/lqFGnIUtqTFZ_GHp46z48Q)

* 为什么使用 MQ？
* MQ 有什么优缺点？
* 几种 MQ 产品的对比，以及适用场景



